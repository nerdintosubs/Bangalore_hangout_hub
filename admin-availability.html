<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Availability Admin - BLR Hangout Hub</title>
  <style>
    :root {
      color-scheme: light;
    }
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #f8fafc;
      color: #0f172a;
      margin: 0;
      padding: 24px;
    }
    .wrap {
      max-width: 720px;
      margin: 0 auto;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06);
    }
    h1 {
      margin: 0 0 16px;
      font-size: 22px;
    }
    p.muted {
      color: #475569;
      margin-top: 0;
    }
    label {
      display: block;
      font-weight: 600;
      margin: 16px 0 6px;
    }
    input, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #cbd5f5;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea {
      min-height: 90px;
    }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .btn {
      margin-top: 18px;
      background: #2563eb;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn:disabled {
      opacity: 0.7;
      cursor: default;
    }
    .status {
      margin-top: 16px;
      padding: 10px 12px;
      border-radius: 8px;
    }
    .status.ok {
      background: #ecfdf3;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }
    .status.err {
      background: #fff1f2;
      color: #9f1239;
      border: 1px solid #fecdd3;
    }
    .hint {
      font-size: 12px;
      color: #64748b;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Availability Admin</h1>
    <p class="muted">Update the daily access code and therapist availability.</p>

    <label for="token">Admin Token</label>
    <input id="token" type="password" placeholder="Paste your admin token" />
    <div class="hint">Stored in session storage for this tab only.</div>

    <div class="row">
      <div>
        <label for="date">Date (YYYY-MM-DD)</label>
        <input id="date" type="date" required />
      </div>
      <div>
        <label for="pass">Access Code</label>
        <input id="pass" type="text" placeholder="e.g. BLR0501" required />
      </div>
    </div>

    <label for="therapists">Therapist IDs (comma-separated)</label>
    <input id="therapists" type="text" placeholder="e.g. t1,t3" required />

    <label for="note">Note</label>
    <textarea id="note" placeholder="Optional note shown in the customer area"></textarea>

    <button id="submit" class="btn" type="button">Publish Availability</button>

    <div id="status" class="status" style="display:none"></div>
  </main>

  <script>
    (function () {
      var tokenEl = document.getElementById('token');
      var dateEl = document.getElementById('date');
      var passEl = document.getElementById('pass');
      var therapistsEl = document.getElementById('therapists');
      var noteEl = document.getElementById('note');
      var submitEl = document.getElementById('submit');
      var statusEl = document.getElementById('status');

      var cachedToken = sessionStorage.getItem('availabilityAdminToken');
      if (cachedToken) {
        tokenEl.value = cachedToken;
      }

      function setStatus(kind, text) {
        statusEl.className = 'status ' + kind;
        statusEl.textContent = text;
        statusEl.style.display = 'block';
      }

      function todayLocalISO() {
        var d = new Date();
        var tz = d.getTimezoneOffset() * 60000;
        return new Date(d - tz).toISOString().slice(0, 10);
      }

      dateEl.value = todayLocalISO();

      submitEl.addEventListener('click', function () {
        var token = tokenEl.value.trim();
        var date = dateEl.value.trim();
        var pass = passEl.value.trim();
        var therapistList = therapistsEl.value.split(',').map(function (t) {
          return t.trim();
        }).filter(Boolean);
        var note = noteEl.value.trim();

        if (!token || !date || !pass || therapistList.length === 0) {
          setStatus('err', 'Fill in token, date, access code, and at least one therapist.');
          return;
        }

        sessionStorage.setItem('availabilityAdminToken', token);
        submitEl.disabled = true;

        fetch('/.netlify/functions/availability-admin', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token,
          },
          body: JSON.stringify({
            date: date,
            pass: pass,
            therapists: therapistList,
            note: note,
          }),
        })
          .then(function (res) {
            return res.json().then(function (data) {
              return { ok: res.ok, data: data };
            });
          })
          .then(function (result) {
            if (result.ok) {
              setStatus('ok', 'Availability updated for ' + date + '.');
            } else {
              setStatus('err', result.data && result.data.error ? result.data.error : 'Failed to update.');
            }
          })
          .catch(function () {
            setStatus('err', 'Request failed. Please try again.');
          })
          .finally(function () {
            submitEl.disabled = false;
          });
      });
    })();
  </script>
</body>
</html>
